---
description: 在任務產生後，對 spec.md、plan.md 及 tasks.md 進行非破壞性的跨產物一致性與品質分析。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## 使用者輸入

```text
$ARGUMENTS
```

你在執行前（若用戶輸入不為空）**必須**考慮用戶輸入內容。

## 目標

在實作前，識別三大核心產物（`spec.md`、`plan.md`、`tasks.md`）中的不一致、重複、模糊及規格不足項目。本指令**僅能**在`/tasks`已成功產生完整`tasks.md`後執行。

## 操作限制

**嚴格唯讀**：**不得**修改任何檔案。僅輸出結構化分析報告。可選擇性提供修正建議（需用戶明確同意後，才可手動執行後續編輯指令）。

**憲章權威**：專案憲章（`/memory/constitution.md`）在本分析範圍內**不可協商**。若與憲章衝突，視為**嚴重（CRITICAL）**，必須調整規格、計畫或任務，而非淡化、曲解或默默忽略原則。若需更動原則本身，必須在`/analyze`之外，另行明確執行憲章更新。

## 執行步驟

### 1. 初始化分析上下文

自 repo 根目錄執行`{SCRIPT}`一次，解析 JSON 以取得 FEATURE_DIR 與 AVAILABLE_DOCS。推導絕對路徑：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如有必要檔案缺失，則中止並顯示錯誤訊息（指示用戶先執行缺少的前置指令）。
對於參數中的單引號（如 "I'm Groot"），請使用跳脫語法：例如 'I'\''m Groot'（或盡可能使用雙引號："I'm Groot"）。

### 2. 載入產物（漸進式揭露）

僅載入每個產物中最必要的上下文：

**來自 spec.md：**

- 概述／上下文
- 功能性需求（Functional Requirements）
- 非功能性需求（Non-Functional Requirements）
- 使用者故事（User Stories）
- 邊界情境（Edge Cases，如有）

**來自 plan.md：**

- 架構／技術堆疊選擇
- 資料模型參考
- 階段劃分
- 技術限制

**來自 tasks.md：**

- 任務 ID
- 描述
- 階段分組
- 平行標記 [P]
- 參考檔案路徑

**來自憲章：**

- 載入`/memory/constitution.md`以驗證原則

### 3. 建立語意模型

建立內部表示（輸出中**不包含**原始產物內容）：

- **需求清單**：每個功能性與非功能性需求，皆需有穩定鍵值（依命令式片語產生 slug，例如 "User can upload file" → `user-can-upload-file`）
- **使用者故事／動作清單**：獨立的使用者動作及其驗收標準
- **任務覆蓋對應**：將每個任務對應到一個或多個需求或故事（依關鍵字／明確參照模式如 ID 或關鍵片語推斷）
- **憲章規則集**：擷取原則名稱及 MUST／SHOULD 規範性陳述

### 4. 偵測流程（高訊號、節省 Token）

聚焦於高訊號發現。最多列出 50 項發現，超出部分彙總於溢出摘要。

#### A. 重複偵測

- 識別近似重複的需求
- 標記品質較差的表述以利合併

#### B. 模糊偵測

- 標記缺乏可衡量標準的模糊形容詞（如 fast、scalable、secure、intuitive、robust）
- 標記未解決的占位符（如 TODO、TKTK、???、`<placeholder>` 等）

#### C. 規格不足

- 僅有動詞、缺乏對象或可衡量結果的需求
- 缺乏驗收標準對應的使用者故事
- 任務參考了 spec/plan 未定義的檔案或元件

#### D. 憲章對齊

- 任何與 MUST 原則衝突的需求或計畫項目
- 憲章要求但缺漏的章節或品質檢查點

#### E. 覆蓋缺口

- 沒有任何任務對應的需求
- 沒有對應需求／故事的任務
- 非功能性需求未反映於任務（如效能、安全性）

#### F. 不一致

- 術語漂移（同一概念在不同檔案名稱不一致）
- plan 參考的資料實體在 spec 缺失（或反之）
- 任務順序矛盾（如整合任務在基礎設置任務之前，卻未註明相依性）
- 需求互相衝突（如一處要求 Next.js，另一處指定 Vue）

### 5. 嚴重性分級

請依下述準則為發現事項分級：

- **CRITICAL（嚴重）**：違反憲章 MUST、缺少核心規格產物、或零覆蓋且阻礙基本功能的需求
- **HIGH（高）**：重複或衝突需求、模糊的安全／效能屬性、不可測試的驗收標準
- **MEDIUM（中）**：術語漂移、缺少非功能性任務覆蓋、規格不足的邊界情境
- **LOW（低）**：風格／措辭改善、對執行順序無影響的小幅冗餘

### 6. 產出精簡分析報告

輸出 Markdown 格式報告（**不寫入檔案**），結構如下：

## 規格分析報告

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|------|--------|------|------|------|
| A1 | 重複 | HIGH | spec.md:L120-134 | 兩項需求內容相似 ... | 合併表述，保留較清晰版本 |

（每個發現一行；ID 以類別首字母為前綴，並保持穩定。）

**覆蓋摘要表：**

| 需求鍵值 | 有任務？ | 任務 ID | 備註 |
|----------|----------|---------|------|

**憲章對齊問題：**（如有）

**未對應任務：**（如有）

**指標：**

- 需求總數
- 任務總數
- 覆蓋率（有至少 1 個任務的需求）
- 模糊項目數
- 重複項目數
- 嚴重（CRITICAL）問題數

### 7. 提供後續行動建議

報告結尾，輸出簡明的後續行動區塊：

- 若有 CRITICAL 問題：建議在執行`/implement`前先解決
- 若僅有 LOW／MEDIUM：可繼續進行，但提供改善建議
- 明確建議可執行指令：如「執行 /specify 進行細化」、「執行 /plan 調整架構」、「手動編輯 tasks.md，補足 'performance-metrics' 覆蓋」

### 8. 提供修正建議

詢問用戶：「是否需要我針對前 N 項問題，提出具體修正建議？」（**絕不自動套用**。）

## 操作原則

### 上下文效率

- **最小高訊號 token**：聚焦可行動發現，避免冗長文件
- **漸進式揭露**：逐步載入產物，避免一次性匯入全部內容
- **節省 token 輸出**：發現表格最多 50 行，超出部分摘要
- **結果可重現**：無變更時重跑，ID 與計數應一致

### 分析指引

- **絕不修改檔案**（僅限唯讀分析）
- **絕不臆造缺失章節**（若缺失，需如實回報）
- **優先處理憲章違規**（此類永遠為 CRITICAL）
- **以實例為主，非泛泛而談**（引用具體案例，不列舉通則）
- **零問題時也要優雅回報**（輸出成功報告及覆蓋統計）

## 上下文

{ARGS}

