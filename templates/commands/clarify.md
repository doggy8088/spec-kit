---
description: 透過提出最多 5 個高度針對性的釐清問題，找出目前功能規格說明中規格不明確的區域，並將答案編碼回規格說明中。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 用戶輸入

```text
$ARGUMENTS
```

你在執行前（若用戶輸入不為空）**必須**考慮用戶輸入內容。

## 大綱

目標：偵測並減少目前功能規格說明中的模糊或缺失決策點，並將釐清內容直接記錄於規格說明檔案中。

注意：本釐清流程預期需在執行 `/speckit.plan` 之前完成。如果用戶明確表示要跳過釐清（例如：探索性 spike），你可以繼續，但必須警告下游返工風險將增加。

執行步驟：

1. 從 repo 根目錄**僅執行一次** `{SCRIPT}`（合併 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇性擷取 `IMPL_PLAN`、`TASKS`，以利未來串接流程。）
   - 若 JSON 解析失敗，請中止並指示用戶重新執行 `/speckit.specify` 或檢查功能分支環境。
   - 若參數中有單引號，如 "I'm Groot"，請使用跳脫語法：例如 'I'\''m Groot'（或若可行則用雙引號："I'm Groot"）。

2. 載入目前的規格說明檔。依據下列分類進行結構化的模糊性與覆蓋性掃描。對每個分類標記狀態：明確 / 部分 / 缺失。產生內部覆蓋地圖以供優先排序（除非不會提出任何問題，否則請勿輸出原始地圖）。

   功能範圍與行為：
   - 核心用戶目標與成功標準
   - 明確界定不在範圍內的聲明
   - 用戶角色 / 人格區分

   領域與資料模型：
   - entity、屬性、關聯
   - 身分識別與唯一性規則
   - 生命週期 / 狀態轉換
   - 資料量 / 規模假設

   互動與使用者體驗流程：
   - 關鍵用戶旅程 / 操作序列
   - 錯誤 / 空值 / 載入狀態
   - 無障礙或在地化備註

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（橫向/縱向、上限）
   - 可靠性與可用性（正常運作時間、復原預期）
   - 可觀察性（紀錄、指標、追蹤訊號）
   - 安全性與隱私（認證/授權、資料保護、威脅假設）
   - 合規 / 法規限制（如有）

   整合與外部相依性：
   - 外部服務 / API 及失敗模式
   - 資料匯入/匯出格式
   - 協定 / 版本假設

   邊界情境與失敗處理：
   - 負面情境
   - 流量限制 / 節流
   - 衝突解決（如：同時編輯）

   限制與取捨：
   - 技術限制（語言、儲存、主機）
   - 明確取捨或已拒絕的替代方案

   術語與一致性：
   - 標準詞彙表用語
   - 避免同義詞 / 已棄用詞彙

   完成訊號：
   - 驗收標準可測試性
   - 可衡量的完成定義（Definition of Done）指標

   其他 / 占位符：
   - TODO 標記 / 未決定事項
   - 模糊形容詞（如「健全」、「直覺」）未量化

   對於每個標記為部分或缺失的分類，除非：
   - 釐清不會實質影響實作或驗證策略
   - 該資訊更適合規劃階段再處理（僅內部記錄）
   否則請加入候選釐清問題機會。

3. 產生（內部使用）優先排序的候選釐清問題佇列（最多 5 題）。**切勿一次全部輸出**。請遵循以下限制：
    - 單次流程最多 10 題。
    - 每題必須可用下列**其中一種**方式回答：
       * 簡短的多選題（2–5 個明確且互斥的選項），或
       * 一個單詞 / 短語答案（明確限制：「回答不超過 5 個字」）。
   - 僅納入那些答案會實質影響架構、資料建模、任務拆解、測試設計、使用者體驗行為、營運準備或合規驗證的問題。
   - 確保分類覆蓋平衡：優先處理影響最大且未解決的分類；避免在高影響區尚未釐清時，重複詢問低影響問題。
   - 排除已回答、瑣碎風格偏好或僅涉及規劃層級執行細節（除非阻礙正確性）。
   - 優先釐清能減少後續返工風險或避免驗收測試誤差的問題。
   - 若未解決分類超過 5 個，依（影響力 * 不確定性）排序，取前 5 名。

4. 逐步互動式提問流程：
    - 每次**只呈現一題**。
    - 若為多選題：
       * **分析所有選項**，並根據下列依據判斷**最適合的選項**：
          - 該專案類型的最佳實踐
          - 類似實作的常見模式
          - 風險降低（安全性、效能、可維護性）
          - 與規格說明中明確專案目標或限制的一致性
       * 將**推薦選項明顯置頂**，並以 1–2 句說明推薦原因。
       * 格式為：`**Recommended:** Option [X] - <reasoning>`
       * 接著以 Markdown 表格呈現所有選項：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> |（如需 D/E 最多至 5 個）
       | Short | 提供不同的簡短答案（<=5 字）|（僅在適合自由回答時加入）

       * 表格後加上：`You can reply with the option letter (e.g., "A"), accept the recommendation by saying "yes" or "recommended", or provide your own short answer.`
    - 若為短答題（無明確離散選項）：
       * 根據最佳實踐與上下文，提供**建議答案**。
       * 格式為：`**Suggested:** <your proposed answer> - <brief reasoning>`
       * 然後輸出：`Format: Short answer (<=5 words). You can accept the suggestion by saying "yes" or "suggested", or provide your own answer.`
    - 用戶回答後：
       * 若用戶回覆「yes」、「recommended」或「suggested」，則採用你先前的推薦/建議作為答案。
       * 否則，驗證答案是否對應某一選項或符合 <=5 字限制。
       * 若仍有模糊，請快速追問釐清（仍屬同一題，不計入新題）。
       * 一旦滿意，將答案記錄於工作記憶中（暫不寫入磁碟），並進入下一題。
    - 當出現下列情況時停止提問：
       * 所有關鍵模糊已提前解決（剩餘佇列問題不再必要），或
       * 用戶明確表示完成（如「done」、「good」、「no more」），或
       * 已詢問 5 題。
    - 絕不提前揭露未來佇列問題。
    - 若一開始就沒有有效問題，立即回報無關鍵模糊。

5. 每次答案確認後的整合（增量更新）：
    - 維持記憶體內規格說明表示（啟動時載入一次）及原始檔案內容。
    - 本次互動的第一個整合答案時：
       * 確認存在 `## Clarifications` 區段（若缺則依規格說明範本於最高層上下文/總覽區段之後建立）。
       * 於其下建立（若尚未存在）今日的 `### Session YYYY-MM-DD` 子標題。
    - 每次答案接受後立即新增一條項目符號：`- Q: <question> → A: <final answer>`。
    - 然後立即將釐清內容整合至最適合的區段：
       * 功能模糊 → 更新或新增於功能性需求（Functional Requirements）項目。
       * 用戶互動 / 角色區分 → 更新用戶故事或角色子區段（如有）以明確角色、限制或情境。
       * 資料結構 / entity → 更新資料模型（Data Model），新增欄位、型別、關聯，並簡要註記新增限制。
       * 非功能性限制 → 於非功能/品質屬性區段新增或修改可衡量標準（將模糊形容詞轉為指標或明確目標）。
       * 邊界情境 / 負面流程 → 新增於邊界情境 / 錯誤處理（Edge Cases / Error Handling）項目（或依範本提供占位符建立該子區段）。
       * 術語衝突 → 全規格說明統一用語；如需保留原詞，僅加註 `(formerly referred to as "X")` 一次。
    - 若釐清內容使先前模糊敘述失效，請直接取代該敘述，不得重複或留下過時矛盾內容。
    - 每次整合後立即儲存規格說明檔（原子性覆寫），以降低上下文遺失風險。
    - 保持格式：不重排無關區段，維持標題階層。
    - 每次插入釐清內容務必簡明且可驗證（避免敘事偏離）。

6. 驗證（每次寫入後及結束時皆執行）：
   - 釐清區段每個接受答案僅有一條項目符號（無重複）。
   - 總提問（接受）數量 ≤ 5。
   - 更新區段不得殘留原本應解決的模糊占位符。
   - 不得有矛盾的舊敘述（需檢查並移除失效選項）。
   - Markdown 結構有效；僅允許新增標題：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：所有更新區段皆用相同標準用語。

7. 將更新後的規格說明寫回 `FEATURE_SPEC`。

8. 回報完成（於提問流程結束或提前終止時）：
   - 已提問與回答的題數。
   - 更新後規格說明路徑。
   - 受影響區段（列出名稱）。
   - 覆蓋性摘要表，列出每個分類及其狀態：已解決（原為部分/缺失且已處理）、延後（超過題數上限或更適合規劃階段）、明確（原本就足夠）、未解決（仍為部分/缺失但影響低）。
   - 若仍有未解決或延後分類，建議是否繼續執行 `/speckit.plan` 或於規劃後再執行 `/speckit.clarify`。
   - 建議下一步指令。

行為規則：
- 若未發現有意義的模糊（或所有潛在問題皆屬低影響），請回應：「未偵測到值得正式釐清的關鍵模糊。」並建議繼續後續步驟。
- 若規格說明檔案不存在，請指示用戶先執行 `/speckit.specify`（此處不得新建規格說明）。
- 總提問數不得超過 5 題（針對同一題的釐清重問不計入新題）。
- 除非技術堆疊缺失會阻礙功能釐清，否則避免臆測技術堆疊問題。
- 尊重用戶提前終止指令（如「stop」、「done」、「proceed」）。
 - 若因覆蓋性已足而未提問，請輸出簡明覆蓋性摘要（所有分類皆為明確），並建議繼續。
 - 若達到題數上限但仍有未解決高影響分類，請明確於延後區段標註並說明原因。

優先排序上下文：{ARGS}

