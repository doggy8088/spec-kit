---
description: 透過提出最多 5 個高度聚焦的釐清問題，辨識目前功能規格中規格不明確的區域，並將答案編碼回規格文件中。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

使用者輸入可以直接由代理程式提供，或作為指令參數傳入——你在進行提示前**必須**先考慮該輸入（若非空）。

使用者輸入：

$ARGUMENTS

目標：偵測並減少現有功能規格中的模糊或缺失決策點，並將釐清內容直接記錄於規格檔案中。

注意：此釐清流程預期應在執行 `/plan` 之前執行（並完成）。若使用者明確表示要跳過釐清（例如：探索性 spike），你可以繼續，但必須警告後續返工風險會增加。

執行步驟：

1. 從 repo 根目錄執行 `{SCRIPT}` **一次**（合併 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小化的 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇性擷取 `IMPL_PLAN`、`TASKS` 以供未來串接流程使用。）
   - 若 JSON 解析失敗，請中止並指示使用者重新執行 `/specify` 或確認功能分支環境。

2. 載入目前的規格文件。使用下列分類法進行結構化的模糊性與覆蓋範圍掃描。對每個分類標記狀態：明確 / 部分 / 缺失。產生內部覆蓋地圖以用於優先排序（除非沒有要詢問的問題，否則不要輸出原始地圖）。

   功能範疇與行為：
   - 核心使用者目標與成功標準
   - 明確界定不在範圍內的項目
   - 使用者角色 / 人格區分

   領域與資料模型：
   - 實體、屬性、關聯
   - 身份與唯一性規則
   - 生命週期／狀態轉換
   - 資料量／規模假設

   互動與使用者體驗流程：
   - 關鍵使用者旅程／操作序列
   - 錯誤／空／載入狀態
   - 無障礙或在地化備註

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平／垂直、限制）
   - 可靠性與可用性（正常運作時間、復原預期）
   - 可觀察性（日誌、指標、追蹤訊號）
   - 安全性與隱私（認證／授權、資料保護、威脅假設）
   - 合規／法規約束（如有）

   整合與外部依賴：
   - 外部服務／API 及失敗模式
   - 資料匯入／匯出格式
   - 協定／版本假設

   邊界情境與失敗處理：
   - 負面情境
   - 速率限制／節流
   - 衝突解決（例如：並發編輯）

   限制與取捨：
   - 技術限制（語言、儲存、主機）
   - 明確取捨或已拒絕的替代方案

   術語與一致性：
   - 標準詞彙表術語
   - 避免同義詞／已棄用術語

   完成訊號：
   - 驗收標準可測試性
   - 可量測的完成定義（Definition of Done）指標

   其他／佔位符：
   - TODO 標記／未決定事項
   - 模糊形容詞（如「健全」、「直覺式」）未量化

   對於每個狀態為「部分」或「缺失」的分類，除非：
   - 釐清不會實質改變實作或驗證策略
   - 該資訊更適合於規劃階段再處理（請內部註記）
   否則請新增一個候選問題機會。

3. 內部產生候選釐清問題的優先佇列（最多 5 題）。**不要**一次性全部輸出。請遵循以下限制：
    - 全流程最多 5 題。
    - 每題必須可用下列任一方式回答：
       * 簡短的多選（2–5 個明確互斥選項），或
       * 一個單詞／短語回答（明確限制：「答案 ≤5 個字」）。
   - 僅納入答案會實質影響架構、資料建模、任務拆解、測試設計、使用者體驗行為、營運準備或合規驗證的問題。
   - 確保分類覆蓋平衡：優先處理高影響未解決分類；避免兩個低影響問題取代一個高影響（如安全性立場）未解決問題。
   - 排除已回答、瑣碎風格偏好或計劃層級執行細節（除非阻礙正確性）。
   - 優先釐清能減少後續返工風險或避免驗收測試誤差的問題。
   - 若未解決分類超過 5 項，請依「影響力 * 不確定性」啟發式選出前 5 項。

4. 逐步提問迴圈（互動式）：
    - 每次**只呈現一題**。
    - 多選題請以 Markdown 表格呈現選項：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> |（如需，最多加到 D/E）
       | Short | 提供不同的簡短答案（≤5 字）|（僅當允許自由回答時加入）

    - 若為短答題（無明確離散選項），請在問題後輸出單行：`Format: Short answer (<=5 words)`。
    - 使用者回答後：
       * 驗證答案是否對應某選項或符合 ≤5 字限制。
       * 若有歧義，請快速釐清（仍算同一題，不進入下一題）。
       * 一旦滿意，將答案記錄於工作記憶（暫不寫入磁碟），進入下一題。
    - 停止提問時機：
       * 所有關鍵模糊性提前解決（剩餘佇列項目已無必要），或
       * 使用者明確表示完成（如「done」、「good」、「no more」），或
       * 已問滿 5 題。
    - 絕不提前揭露未來佇列問題。
    - 若一開始就無有效問題，立即回報無關鍵模糊性。

5. 每次答案接受後進行整合（增量更新）：
    - 維持規格檔的記憶體內表示（啟動時載入一次）與原始檔案內容。
    - 本次會話首次整合答案時：
       * 確認存在 `## Clarifications` 區段（若缺則依規格模板於最高層次情境／概述區段之後建立）。
       * 於其下建立（如無則新增）今日的 `### Session YYYY-MM-DD` 子標題。
    - 接受答案後立即新增一條項目符號：`- Q: <question> → A: <final answer>`。
    - 隨即將釐清內容套用至最適合的區段：
       * 功能模糊性 → 更新或新增至功能需求項目。
       * 使用者互動／角色區分 → 更新使用者故事或角色子區段（如有）以明確角色、限制或情境。
       * 資料型態／實體 → 更新資料模型（新增欄位、型態、關聯並保持順序）；簡明註記新增限制。
       * 非功能性限制 → 於非功能／品質屬性區段新增或修改可量測標準（將模糊形容詞轉為指標或明確目標）。
       * 邊界情境／負面流程 → 於邊界情境／錯誤處理下新增項目（如模板有佔位符則建立該子區段）。
       * 術語衝突 → 全規格統一術語；如需保留原詞，僅於必要時加註 `(formerly referred to as "X")`。
    - 若釐清內容使先前模糊敘述失效，請直接取代原敘述，避免重複或矛盾內容。
    - 每次整合後立即儲存規格檔（原子性覆寫），以降低遺失上下文風險。
    - 保持格式：不重排無關區段，維持標題階層。
    - 每次釐清內容應簡明且可測試（避免敘述偏離主題）。

6. 驗證（每次寫入後及最後一次）：
   - 釐清會話每個接受答案僅有一條項目（無重複）。
   - 問答總數 ≤ 5。
   - 已更新區段不再殘留原本要解決的模糊佔位符。
   - 無矛盾的早期敘述殘留（檢查並移除現已無效的選項）。
   - Markdown 結構有效；僅允許新增標題：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：所有更新區段皆使用同一標準術語。

7. 將更新後的規格寫回 `FEATURE_SPEC`。

8. 回報完成（於提問迴圈結束或提前終止時）：
   - 已提問並回答的題數。
   - 更新後規格檔路徑。
   - 影響到的區段（列出名稱）。
   - 覆蓋摘要表，列出每個分類及狀態：已解決（原為部分／缺失且已處理）、延後（超出問題配額或較適合規劃階段）、明確（已充分）、未解決（仍部分／缺失但影響低）。
   - 若仍有未解決或延後項目，建議是否繼續執行 `/plan` 或於規劃後再執行 `/clarify`。
   - 建議下一步指令。

行為規則：
- 若未發現有意義的模糊性（或所有潛在問題皆為低影響），請回覆：「未偵測到值得正式釐清的關鍵模糊性。」並建議繼續。
- 若規格檔缺失，請指示使用者先執行 `/specify`（此處不建立新規格）。
- 絕不超過 5 題（同一題釐清重問不算新題）。
- 除非缺失阻礙功能明確性，否則避免推測技術堆疊問題。
- 尊重使用者提前終止指令（如「stop」、「done」、「proceed」）。
 - 若因覆蓋率已全滿未提問，請輸出簡明覆蓋摘要（所有分類皆為明確）並建議繼續。
 - 若配額用盡仍有高影響分類未解決，請於延後項下明確標註並說明原因。

優先排序參考上下文：{ARGS}
