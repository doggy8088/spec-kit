---
description: 透過提出最多 5 個高度聚焦的釐清問題，找出目前功能規格說明中規格不足的區域，並將答案編碼回規格說明中。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 用戶輸入

```text
$ARGUMENTS
```

你在進行後續操作前，**必須**考慮用戶輸入（若非空）。

## 大綱

目標：偵測並減少目前功能規格說明中的模糊或缺失決策點，並將釐清結果直接記錄於規格檔案中。

注意：此釐清流程預期應在執行 `/speckit.plan` 前運行並完成。若用戶明確表示要跳過釐清（例如：探索性 spike），你可以繼續，但必須警告後續返工風險會增加。

執行步驟：

1. 從 repo 根目錄執行 `{SCRIPT}` **一次**（合併 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小的 JSON 負載欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇性擷取 `IMPL_PLAN`、`TASKS` 以供未來串接流程使用。）
   - 若 JSON 解析失敗，請中止並指示用戶重新執行 `/speckit.specify` 或確認功能分支環境。
   - 對於參數中如 "I'm Groot" 這類單引號，請使用跳脫語法：例如 'I'\''m Groot'（或若可行則用雙引號："I'm Groot"）。

2. 載入目前的規格檔。使用下列分類法進行結構化的模糊性與覆蓋範圍掃描。對每個分類標記狀態：明確 / 部分 / 缺失。產生一份內部覆蓋地圖以用於優先排序（除非不會提出任何問題，否則不要輸出原始地圖）。

   功能範圍與行為：
   - 核心用戶目標與成功標準
   - 明確的超出範圍聲明
   - 用戶角色 / 人格區分

   領域與資料模型：
   - 實體、屬性、關聯
   - 身分識別與唯一性規則
   - 生命週期/狀態轉換
   - 資料量 / 規模假設

   互動與使用者體驗流程：
   - 關鍵用戶旅程 / 操作序列
   - 錯誤/空值/載入狀態
   - 無障礙或在地化備註

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（橫向/縱向、限制）
   - 可靠性與可用性（運作時間、復原預期）
   - 可觀測性（紀錄、指標、追蹤訊號）
   - 安全性與隱私（認證/授權、資料保護、威脅假設）
   - 合規 / 法規約束（如有）

   整合與外部相依性：
   - 外部服務/API 及失敗模式
   - 資料匯入/匯出格式
   - 協定/版本假設

   邊界情境與失敗處理：
   - 負面情境
   - 流量限制 / 節流
   - 衝突解決（例如：同時編輯）

   限制與取捨：
   - 技術限制（語言、儲存、託管）
   - 明確的取捨或已拒絕方案

   術語與一致性：
   - 標準詞彙表術語
   - 避免同義詞 / 已棄用術語

   完成訊號：
   - 驗收標準可測試性
   - 可衡量的完成定義（Definition of Done）指標

   其他 / 占位符：
   - TODO 標記 / 未決策事項
   - 缺乏量化的模糊形容詞（如「健壯」、「直覺」）

   對於每個狀態為「部分」或「缺失」的分類，除非：
   - 釐清後不會實質影響實作或驗證策略
   - 該資訊更適合於規劃階段再處理（僅作內部註記）
   否則請新增一個候選問題機會。

3. 產生（內部使用）一個優先排序的候選釐清問題佇列（最多 5 題）。**切勿**一次性全部輸出。請遵循以下限制：
    - 全流程最多 10 題。
    - 每題必須可用下列任一方式回答：
       - 簡短的多選（2–5 個明確互斥選項），或
       - 一個單字 / 短語答案（明確限制：「答案不超過 5 個字」）。
    - 僅納入答案會實質影響架構、資料建模、任務分解、測試設計、使用者體驗行為、營運準備或合規驗證的問題。
    - 確保分類覆蓋均衡：優先解決高影響未解類別；避免兩個低影響問題取代一個高影響（如安全性立場）未解問題。
    - 排除已回答、瑣碎風格偏好或計畫層級執行細節（除非影響正確性）。
    - 優先釐清能減少後續返工風險或避免驗收測試錯誤對齊的問題。
    - 若未解類別超過 5 個，請依（影響力 * 不確定性）啟發式選前 5 個。

4. 互動式提問循環：
    - 每次**僅呈現一題**。
    - 若為多選題：
       - **分析所有選項**，並根據下列依據**判斷最合適選項**：
          - 該專案類型最佳實踐
          - 類似實作的常見模式
          - 風險降低（安全性、效能、可維護性）
          - 與規格中任何明確專案目標或限制的一致性
       - 將你的**推薦選項明顯置頂**，並以 1–2 句說明為何這是最佳選擇。
       - 格式如下：`**Recommended:** Option [X] - <reasoning>`
       - 然後以 Markdown 表格呈現所有選項：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> (如需 D/E 最多 5 項) |
       | Short | 提供不同的簡短答案（<=5 字）（僅在適合自由輸入時包含） |

       - 表格後加上：`You can reply with the option letter (e.g., "A"), accept the recommendation by saying "yes" or "recommended", or provide your own short answer.`
    - 若為短答型（無明確離散選項）：
       - 根據最佳實踐與上下文，給出**建議答案**。
       - 格式如下：`**Suggested:** <your proposed answer> - <brief reasoning>`
       - 然後輸出：`Format: Short answer (<=5 words). You can accept the suggestion by saying "yes" or "suggested", or provide your own answer.`
    - 用戶回答後：
       - 若用戶回覆 "yes"、"recommended" 或 "suggested"，則採用你先前的推薦/建議作為答案。
       - 否則，驗證答案是否對應某個選項或符合 <=5 字限制。
       - 若有歧義，請快速追問釐清（此仍算同一題，不計入新問題）。
       - 一旦滿意，將答案記錄於工作記憶（暫不寫入磁碟），並進入下一題。
    - 停止提問時機：
       - 所有關鍵模糊點提前解決（剩餘佇列問題無需再問），或
       - 用戶明確表示完成（"done"、"good"、"no more"），或
       - 已問滿 5 題。
    - 絕不提前揭露後續佇列問題。
    - 若一開始無有效問題，立即回報無關鍵模糊點。

5. 每次答案接受後進行整合（增量更新）：
    - 維持記憶體中的規格表示（啟動時載入一次）及原始檔案內容。
    - 本次會話首次整合答案時：
       - 確保存在 `## Clarifications` 區段（若缺則依規格範本於最高層次上下文/總覽區段之後建立）。
       - 於其下建立（若尚未存在）今日的 `### Session YYYY-MM-DD` 子標題。
    - 接受答案後立即新增一條項目符號：`- Q: <question> → A: <final answer>`。
    - 隨即將釐清內容套用至最適合的區段：
       - 功能模糊 → 更新或新增於功能性需求區段。
       - 用戶互動/角色區分 → 於 User Stories 或 Actors 子區段（如有）補充明確角色、限制或情境。
       - 資料結構/實體 → 更新資料模型（新增欄位、型別、關聯），並簡明註記新增限制。
       - 非功能性限制 → 於非功能/品質屬性區段新增或修改可衡量標準（將模糊形容詞轉為指標或明確目標）。
       - 邊界情境/負向流程 → 於 Edge Cases / Error Handling 區段下新增項目（或依範本設有占位符則建立）。
       - 術語衝突 → 全規格統一術語；如需保留原詞，僅於一次加註 `(formerly referred to as "X")`。
    - 若釐清內容使先前模糊敘述失效，請直接取代原敘述，避免重複或矛盾。
    - 每次整合後**立即儲存規格檔**（原子性覆寫），以降低上下文遺失風險。
    - 保持格式：不重排無關區段，維持標題階層。
    - 每則釐清內容應簡明且可測試（避免敘事偏離主題）。

6. 驗證（每次寫入後及最後一次）：
   - 釐清會話每個接受答案對應一條項目（無重複）。
   - 提問（接受）總數 ≤ 5。
   - 更新區段不再殘留新答案應解決的模糊占位符。
   - 無矛盾的舊敘述殘留（移除現已無效的替代選項）。
   - Markdown 結構有效；僅允許新增標題：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：所有更新區段均使用相同標準術語。

7. 將更新後的規格寫回 `FEATURE_SPEC`。

8. 回報完成（於提問循環結束或提前終止時）：
   - 提問與回答的題數。
   - 更新後規格檔路徑。
   - 影響區段（列出名稱）。
   - 覆蓋摘要表，列出每個分類及狀態：已解決（原為部分/缺失且已處理）、延後（超出提問配額或適合規劃時處理）、明確（已充分）、未解決（仍部分/缺失但影響低）。
   - 若仍有未解決或延後項，建議是否進入 `/speckit.plan` 或於規劃後再執行 `/speckit.clarify`。
   - 建議下一步指令。

行為規則：

- 若未發現有意義的模糊點（或所有潛在問題均屬低影響），請回應：「未偵測到值得正式釐清的關鍵模糊點。」並建議繼續。
- 若規格檔缺失，請指示用戶先執行 `/speckit.specify`（此處不建立新規格）。
- 絕不超過 5 題（同一題釐清重問不算新題）。
- 避免推測技術堆疊問題，除非缺失會阻礙功能明確性。
- 尊重用戶提前終止指令（"stop"、"done"、"proceed"）。
- 若因覆蓋率已足而無需提問，請輸出簡明覆蓋摘要（所有分類皆明確），並建議前進。
- 若配額用盡且仍有高影響未解類別，請明確將其列為延後，並說明理由。

優先排序上下文：{ARGS}
