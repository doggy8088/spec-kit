---
description: 透過提出最多 5 個高度聚焦的釐清問題，找出目前功能規格中規格未明確的區域，並將答案編碼回規格中。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 使用者輸入

```text
$ARGUMENTS
```

在繼續執行前，您**必須**考慮用戶輸入（若非空）。

## 大綱

目標：偵測並減少目前功能規格說明中的模糊或缺失決策點，並直接將釐清內容記錄於規格檔案中。

注意：此釐清流程預期在執行`/speckit.plan`前運行且完成。若用戶明確表示跳過釐清（例如：探索性 spike），您可以繼續，但必須警告後續返工風險將提升。

執行步驟：

1. 從 repo 根目錄**執行`{SCRIPT}`一次**（合併`--json --paths-only`模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇性擷取`IMPL_PLAN`、`TASKS`以供未來串接流程使用。）
   - 若 JSON 解析失敗，請中止並指示用戶重新執行`/speckit.specify`或確認功能分支環境。
   - 若參數中有單引號，如 "I'm Groot"，請使用跳脫語法：例如 'I'\''m Groot'（或若可行則直接用雙引號："I'm Groot"）。

2. 載入目前的規格檔案。依下列分類進行結構化的模糊性與覆蓋性掃描。每個分類標記狀態：明確 / 部分 / 缺失。產生內部覆蓋地圖以用於優先排序（除非不會提出任何問題，否則不要輸出原始地圖）。

   功能範圍與行為：
   - 核心用戶目標與成功標準
   - 明確的非範圍聲明
   - 用戶角色 / 人格區分

   領域與資料模型：
   - entity、屬性、關聯
   - 身分識別與唯一性規則
   - 生命週期／狀態轉換
   - 資料量／規模假設

   互動與 UX 流程：
   - 關鍵用戶旅程／序列
   - 錯誤／空／載入狀態
   - 無障礙或在地化備註

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（橫向／縱向、上限）
   - 可靠性與可用性（正常運作時間、恢復預期）
   - 可觀察性（記錄、指標、追蹤訊號）
   - 安全性與隱私（authN/Z、資料保護、威脅假設）
   - 合規／法規限制（如有）

   整合與外部相依性：
   - 外部服務／API 及失敗模式
   - 資料匯入／匯出格式
   - 協定／版本假設

   邊界情境與失敗處理：
   - 負面情境
   - 流量限制／節流
   - 衝突解決（如同時編輯）

   限制與取捨：
   - 技術限制（語言、儲存、主機）
   - 明確的取捨或已拒絕的替代方案

   術語與一致性：
   - 標準詞彙表術語
   - 避免同義詞／已棄用術語

   完成訊號：
   - 驗收標準可測試性
   - 可衡量的完成定義（Definition of Done）指標

   其他／占位符：
   - TODO 標記／未決定事項
   - 缺乏量化的模糊形容詞（如「健全」、「直覺」）

   對於每個標記為部分或缺失的分類，除非：
   - 釐清不會實質改變實作或驗證策略
   - 該資訊更適合於規劃階段再處理（僅內部備註）
   否則請加入候選問題機會。

3. 產生（僅內部）優先排序的候選釐清問題佇列（最多 5 題）。**切勿一次全部輸出。**請遵循以下限制：
    - 整個會話最多 10 題。
    - 每題必須可用下列**其中一種**方式回答：
       * 簡短的多選（2–5 個明確且互斥的選項），或
       * 一個單字／短語回答（明確限制：「答案 ≤5 字」）。
    - 僅納入那些答案會實質影響架構、資料建模、任務拆解、測試設計、UX 行為、營運準備或合規驗證的問題。
    - 確保分類覆蓋平衡：優先處理影響最大的未解決分類；避免在高影響區域（如安全性立場）未解決時，重複詢問低影響問題。
    - 排除已回答、瑣碎風格偏好或規劃層級執行細節（除非阻礙正確性）。
    - 優先釐清能降低後續返工風險或避免驗收測試錯誤對齊的問題。
    - 若未解決分類超過 5 個，請依（影響力 * 不確定性）啟發式選前 5 個。

4. 逐題互動式詢問循環：
    - 每次**僅呈現一題**。
    - 若為多選題：
       * **分析所有選項**，並根據下列依據**判斷最適合的選項**：
          - 專案類型最佳實踐
          - 類似實作的常見模式
          - 降低風險（安全、效能、可維護性）
          - 與規格中明確專案目標或限制的一致性
       * 將您的**推薦選項明顯置頂**，並附上明確理由（1–2 句說明為何這是最佳選擇）。
       * 格式為：`**Recommended:** Option [X] - <reasoning>`
       * 接著以 Markdown 表格呈現所有選項：

       | Option | Description |
       |--------|-------------|
       | A | <Option A description> |
       | B | <Option B description> |
       | C | <Option C description> |（如需可加入 D/E，最多 5 項）
       | Short | 提供不同的簡短答案（≤5 字）|（僅當適合自由回答時納入）

       * 表格後加上：`You can reply with the option letter (e.g., "A"), accept the recommendation by saying "yes" or "recommended", or provide your own short answer.`
    - 若為短答題（無明確離散選項）：
       * 根據最佳實踐與上下文，提供**建議答案**。
       * 格式為：`**Suggested:** <your proposed answer> - <brief reasoning>`
       * 接著輸出：`Format: Short answer (<=5 words). You can accept the suggestion by saying "yes" or "suggested", or provide your own answer.`
    - 用戶回答後：
       * 若用戶回覆「yes」、「recommended」或「suggested」，則採用您先前的推薦／建議作為答案。
       * 否則，驗證答案是否對應其中一選項或符合 ≤5 字限制。
       * 若仍有模糊，請快速釐清（仍算同一題，不算新問題）。
       * 一旦滿意，將答案記錄於工作記憶（暫不寫入磁碟），並進入下一題。
    - 停止提問時機：
       * 所有關鍵模糊提前解決（剩餘佇列項目已無必要），或
       * 用戶明確表示結束（如「done」、「good」、「no more」），或
       * 已詢問 5 題。
    - 絕不提前揭露未來佇列問題。
    - 若起始時無有效問題，立即回報無關鍵模糊。

5. 每次答案接受後的整合（增量更新）：
    - 維持規格檔的記憶體內表示（啟動時載入一次）及原始檔內容。
    - 本次會話首次整合答案時：
       * 確認有`## Clarifications`區段（若缺則依規格範本於最高層次情境／總覽區段後建立）。
       * 於其下建立（若尚未存在）今日的`### Session YYYY-MM-DD`子標題。
    - 接受後立即新增一條項目：`- Q: <question> → A: <final answer>`。
    - 接著立即將釐清內容整合至最適合區段：
       * 功能模糊 → 更新或新增於功能性需求 (Functional Requirements) 區段。
       * 用戶互動／角色區分 → 於 User Stories 或 Actors 子區段（若有）補充明確角色、限制或情境。
       * 資料結構／entity → 更新資料模型（新增欄位、型別、關聯，並保留順序）；簡明註記新增限制。
       * 非功能性限制 → 於非功能／品質屬性區段新增／修改可衡量標準（將模糊形容詞轉為指標或明確目標）。
       * 邊界情境／負向流程 → 於邊界情境／錯誤處理區段新增項目（如範本有占位符則建立）。
       * 術語衝突 → 全規格統一用詞；如需保留原詞，僅於必要時新增`(formerly referred to as "X")`一次。
    - 若釐清內容使先前模糊敘述失效，請直接取代原敘述，避免重複與矛盾。
    - 每次整合後**立即儲存規格檔**（原子覆寫），以降低上下文遺失風險。
    - 保持格式：不重排無關區段，維持標題階層。
    - 每次插入釐清內容應簡明且可測試（避免敘述漂移）。

6. 驗證（每次寫入後及最後一次總檢）：
   - 釐清會話每個接受答案僅有一條項目（無重複）。
   - 總詢問（接受）題數 ≤ 5。
   - 更新區段無遺留原本應解決的模糊占位符。
   - 無矛盾的舊敘述殘留（檢查並移除已失效的選擇）。
   - Markdown 結構正確；僅允許新增標題：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：所有更新區段皆使用相同標準術語。

7. 將更新後的規格寫回`FEATURE_SPEC`。

8. 回報完成（於詢問循環結束或提前終止時）：
   - 已詢問與回答的題數。
   - 更新後規格檔路徑。
   - 影響到的區段（列出名稱）。
   - 覆蓋摘要表，列出每個分類及其狀態：已解決（原為部分／缺失且已處理）、延後（超出題數上限或較適合規劃階段）、明確（原本就足夠）、未解決（仍為部分／缺失但影響低）。
   - 若有未解決或延後項目，建議是否繼續執行`/speckit.plan`或於規劃後再執行`/speckit.clarify`。
   - 建議下一步指令。

行為規則：
- 若未發現有意義的模糊（或所有潛在問題皆為低影響），回應：「No critical ambiguities detected worth formal clarification.」並建議繼續。
- 若規格檔缺失，請指示用戶先執行`/speckit.specify`（此處不建立新規格）。
- 總詢問題數不得超過 5 題（同一題釐清重問不算新題）。
- 避免推測性技術堆疊問題，除非缺失阻礙功能明確性。
- 尊重用戶提前終止指令（如「stop」、「done」、「proceed」）。
 - 若因已完全覆蓋而未提問，請輸出簡明覆蓋摘要（所有分類皆明確），並建議繼續。
 - 若達到題數上限且仍有高影響未解決分類，請明確標註於延後項目並說明理由。

優先排序參考上下文：{ARGS}
